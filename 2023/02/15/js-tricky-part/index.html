<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Do not use forEach with async-await. Use For loop instead | Ash Zhang</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="
Those thing relates to array/ map / reduce etc.

Do not use forEach with async-await. Use For loop instead

> Ash's quote. This is tricky when you want to do several MongoDB operation in the lo ...">
    <link rel="preload" href="/assets/css/0.styles.c67cf654.css" as="style"><link rel="preload" href="/assets/js/app.6ad6bef8.js" as="script"><link rel="preload" href="/assets/js/10.1d100d77.js" as="script"><link rel="preload" href="/assets/js/3.ce73e18d.js" as="script"><link rel="preload" href="/assets/js/31.596ffe3e.js" as="script"><link rel="prefetch" href="/assets/js/11.fff5d8ce.js"><link rel="prefetch" href="/assets/js/12.79b3d8cc.js"><link rel="prefetch" href="/assets/js/13.388305fb.js"><link rel="prefetch" href="/assets/js/14.7800e24f.js"><link rel="prefetch" href="/assets/js/15.a174a5b9.js"><link rel="prefetch" href="/assets/js/16.65cbd72c.js"><link rel="prefetch" href="/assets/js/17.65da1019.js"><link rel="prefetch" href="/assets/js/18.8ecc43e9.js"><link rel="prefetch" href="/assets/js/19.ebf3365f.js"><link rel="prefetch" href="/assets/js/20.28cc1882.js"><link rel="prefetch" href="/assets/js/21.a4be8b52.js"><link rel="prefetch" href="/assets/js/22.423540d3.js"><link rel="prefetch" href="/assets/js/23.bc716f4c.js"><link rel="prefetch" href="/assets/js/24.d521f490.js"><link rel="prefetch" href="/assets/js/25.ad2eba51.js"><link rel="prefetch" href="/assets/js/26.b938975c.js"><link rel="prefetch" href="/assets/js/27.03984736.js"><link rel="prefetch" href="/assets/js/28.5d37968f.js"><link rel="prefetch" href="/assets/js/29.20c8ca6b.js"><link rel="prefetch" href="/assets/js/30.007eebac.js"><link rel="prefetch" href="/assets/js/32.c828d87f.js"><link rel="prefetch" href="/assets/js/33.757fcba5.js"><link rel="prefetch" href="/assets/js/34.f64e4dba.js"><link rel="prefetch" href="/assets/js/35.9f164c75.js"><link rel="prefetch" href="/assets/js/36.4ee3fb4a.js"><link rel="prefetch" href="/assets/js/37.fb213135.js"><link rel="prefetch" href="/assets/js/38.e4a1628f.js"><link rel="prefetch" href="/assets/js/39.6c286b4e.js"><link rel="prefetch" href="/assets/js/4.0a09b301.js"><link rel="prefetch" href="/assets/js/40.85168d5e.js"><link rel="prefetch" href="/assets/js/5.b16a9191.js"><link rel="prefetch" href="/assets/js/6.b61b3ccf.js"><link rel="prefetch" href="/assets/js/7.873bc081.js"><link rel="prefetch" href="/assets/js/8.2ffe1ad5.js"><link rel="prefetch" href="/assets/js/9.b739b614.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.9b3f7e90.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c67cf654.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">Ash Zhang </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/post/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/notes/" class="nav-link">Notes</a></li><li class="nav-item"><a href="/tag/" class="nav-link">Tags</a></li><li class="nav-item"><a href="/portfolio/" class="nav-link">Portfolio</a></li><li class="nav-item"><a href="/cv/" class="nav-link">CV</a></li><li class="nav-item"><a href="/tool/" class="nav-link">Tools</a></li><li class="nav-item"><a href="https://github.com/zblcool" target="_blank" rel="noopener noreferrer" class="nav-link external">Github</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">Ash Zhang </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/post/" class="nav-link">Blog</a></li><li class="mobile-nav-item"><a href="/notes/" class="nav-link">Notes</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">Tags</a></li><li class="mobile-nav-item"><a href="/portfolio/" class="nav-link">Portfolio</a></li><li class="mobile-nav-item"><a href="/cv/" class="nav-link">CV</a></li><li class="mobile-nav-item"><a href="/tool/" class="nav-link">Tools</a></li><li class="mobile-nav-item"><a href="https://github.com/zblcool" target="_blank" rel="noopener noreferrer" class="nav-link external">Github</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        Do not use forEach with async-await. Use For loop instead
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">Ash</span> <span itemprop="address"> Â  in Runcorn, Brisbane</span></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2023-02-15T00:00:00.000Z">
      Wed Feb 15 2023
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-d832e844><a href="/tag/JavaScript" data-v-d832e844> JavaScript </a></li><li class="post-tag" data-v-d832e844><a href="/tag/Notes" data-v-d832e844> Notes </a></li><li class="post-tag" data-v-d832e844><a href="/tag/Front End" data-v-d832e844> Front End </a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h1 id="array"><a href="#array" class="header-anchor">#</a> Array</h1> <p>Those thing relates to array/ map / reduce etc.</p> <h2 id="do-not-use-foreach-with-async-await-use-for-loop-instead"><a href="#do-not-use-foreach-with-async-await-use-for-loop-instead" class="header-anchor">#</a> Do not use forEach with async-await. Use For loop instead</h2> <blockquote><p>Ash's quote. This is tricky when you want to do several MongoDB operation in the loop. Things may not going the way you want. In my case. I try to insert several new docs into the db and give them a new globalId. and made some change base on each doc.However, using forEach / map in my case. The different doc may have same globalID. since forEach loop is not actual waiting anything.</p></blockquote> <blockquote><p><strong>Use <code>for...of</code> instead of <code>forEach</code> in asynchronous code.</strong>
{.is-success}</p></blockquote> <h3 id="the-problem"><a href="#the-problem" class="header-anchor">#</a> The problem</h3> <p><code>Array.prototype.forEach</code> is not designed for asynchronous code.  (It was not suitable for promises, and it is not suitable for async-await.)</p> <p>For example, the following forEach loop might not do what it appears to do:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> players <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getWinners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// BAD</span>
<span class="token keyword">await</span> players<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">player</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">givePrizeToPlayer</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> <span class="token function">sendEmailToAdmin</span><span class="token punctuation">(</span><span class="token string">'All prizes awarded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>What's wrong with it?</p> <ul><li>The promises returned by the iterator function are not handled.  So if one of them throws an error, the error won't be caught.  (In Node 10, if no <code>unhandledrejection</code> listener has been registered, that will cause the process to crash!)</li> <li>Because <code>forEach</code> does not wait for each promise to resolve, all the prizes are awarded in parallel, not serial (one by one).</li> <li>So the loop actually finishes iterating before any of the prizes have finished being awarded!  (But after they have all started being awarded).</li> <li>As a result, <code>sendEmailToAdmin()</code> sends the email before any of the prizes have finished being awarded.  Maybe none of them will end up being awarded (they might all throw an error)!</li></ul> <h3 id="so-how-should-we-write-this"><a href="#so-how-should-we-write-this" class="header-anchor">#</a> So how should we write this?</h3> <h4 id="process-each-player-in-serial"><a href="#process-each-player-in-serial" class="header-anchor">#</a> Process each player in serial</h4> <p>Fortunately if your language has async-await then it will also have the <code>for...of</code> construction, so you can use that.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> player <span class="token keyword">of</span> players<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">givePrizeToPlayer</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This loop will wait for one prize to be awarded before proceeding to the next one.</p> <p>You could also use a traditional <code>for(...;...;...)</code> here but that is more verbose than we need.</p> <p><em>Note:</em> The airbnb style guide recommends <em>not</em> using <code>for...of</code> for <em>web apps</em> at the current time (2018), because it requires a large polyfill.  If you are working in the browser, use the traditional for mentioned above, or <code>Array.reduce()</code> described below.</p> <h4 id="process-all-the-players-in-parallel"><a href="#process-all-the-players-in-parallel" class="header-anchor">#</a> Process all the players in parallel</h4> <p>If the order doesn't matter, it may be quicker to process all the players in parallel.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>players<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">player</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">givePrizeToPlayer</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>This will start awarding all the prizes at once, but it will wait for all of them to complete before proceeding to <code>sendEmailToAdmin()</code>.</p> <h4 id="process-each-player-in-serial-using-array-prototype-reduce"><a href="#process-each-player-in-serial-using-array-prototype-reduce" class="header-anchor">#</a> Process each player in serial, using <code>Array.prototype.reduce</code></h4> <p>Some people recommend this approach:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> players<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> player</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Wait for the previous item to finish processing</span>
  <span class="token keyword">await</span> a<span class="token punctuation">;</span>
  <span class="token comment">// Process this item</span>
  <span class="token keyword">await</span> <span class="token function">givePrizeToPlayer</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>(We are using the accumulator <code>a</code> not as a total or a summary, but just as a way to pass the promise from the previous item's callback to the next item's callback, so that we can wait for the previous item to finish being processed.)</p> <p>This has pretty much the same behaviour as the <code>for...of</code> above, but is slightly harder to read.</p> <p>However it is recommended by the Airbnb style guide because it can reduce the browser bundle size.  <code>for...of</code> requires iterators, and some browsers require a polyfill for iterators, and that polyfill is quite large.  You can decide on the trade-off between bundle size and developer convenience.</p> <h3 id="so-which-array-functions-can-i-use"><a href="#so-which-array-functions-can-i-use" class="header-anchor">#</a> So which array functions can I use?</h3> <p><em>TLDR:</em> Only <code>map()</code>, <code>reduce()</code>, <code>flatMap()</code> and <code>reduceRight()</code> if used correctly</p> <p>async-await works naturally with <code>for</code> loops and <code>while</code> loops, because they are written in the original function body.</p> <p>But when you call out to another function, it can only work with async-await if it returns a promise, and if that promise is handled (awaited or <code>.then()</code>-ed).</p> <p>That is why we can use <code>.reduce()</code> and <code>.map()</code> above, because in both cases we return a promise (or an array of promises) which we can await.  (In the reduce case, each invocation of the callback function waits for the previous promise to resolve, to ensure sequential processing.)</p> <p>But most array functions will not give us a promise back, or allow a promise to be passed from one call to the next, so they cannot be used asynchronously.  So, for example, you can not use asynchronous code inside <code>array.some()</code> or <code>array.filter()</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// BAD</span>
<span class="token keyword">const</span> playersWithGoodScores <span class="token operator">=</span> <span class="token keyword">await</span> players<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">player</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> score <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">calculateLatestScore</span><span class="token punctuation">(</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> score <span class="token operator">&gt;=</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>It might look like that should work but it won't, because <code>filter</code> was never designed with promises in mind.  When <code>filter</code> calls your callback function, it will get a <code>Promise</code> back, but instead of awaiting that promise, it will just see the promise as &quot;truthy&quot;, and immediately accept the player, regardless of what their score will eventually be.</p> <p>You may be able to find a library of array functions that can work asynchronously, but the standard array functions do not.</p> <blockquote><p>Reference  https://gist.github.com/joeytwiddle/37d2085425c049629b80956d3c618971
{.is-info}</p></blockquote></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#do-not-use-foreach-with-async-await-use-for-loop-instead" title="Do not use forEach with async-await. Use For loop instead">Do not use forEach with async-await. Use For loop instead</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#the-problem" title="The problem">The problem</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#so-how-should-we-write-this" title="So how should we write this?">So how should we write this?</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#so-which-array-functions-can-i-use" title="So which array functions can I use?">So which array functions can I use?</a></div></div></div></div> <footer class="footer" data-v-fdbf4940><div class="footer-left-wrap" data-v-fdbf4940><ul class="contact" data-v-fdbf4940><li class="contact-item" data-v-fdbf4940><a href="https://github.com/zblcool" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-fdbf4940><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-fdbf4940><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-fdbf4940></path></svg>
          
        </a></li><li class="contact-item" data-v-fdbf4940><a href="https://www.instagram.com/zblash95/?hl=zh-cn" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-fdbf4940><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-instagram" data-v-fdbf4940><rect x="2" y="2" width="20" height="20" rx="5" ry="5" data-v-fdbf4940></rect><path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z" data-v-fdbf4940></path><line x1="17.5" y1="6.5" x2="17.5" y2="6.5" data-v-fdbf4940></line></svg>
          
        </a></li><li class="contact-item" data-v-fdbf4940><a href="https://www.linkedin.com/in/baolong-zhang-704062a1/" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-fdbf4940><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-linkedin" data-v-fdbf4940><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z" data-v-fdbf4940></path><rect x="2" y="9" width="4" height="12" data-v-fdbf4940></rect><circle cx="4" cy="4" r="2" data-v-fdbf4940></circle></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-fdbf4940><ul class="copyright" data-v-fdbf4940><li class="copyright-item" data-v-fdbf4940><a href="/2023/02/15/js-tricky-part/.html" class="nav-link" data-v-fdbf4940>Powered by VuePress | Ash Â© 1995-present</a></li></ul></div></footer></div><div class="global-ui"><div class="container" data-v-0178ff65><canvas id="live2d" width="280" height="250" class="live2d-right" data-v-0178ff65></canvas></div></div></div>
    <script src="/assets/js/app.6ad6bef8.js" defer></script><script src="/assets/js/10.1d100d77.js" defer></script><script src="/assets/js/3.ce73e18d.js" defer></script><script src="/assets/js/31.596ffe3e.js" defer></script>
  </body>
</html>
